# Docker image
# Build a Docker image to run, deploy, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/vsts/pipelines/languages/docker

jobs:
- job: Linux
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - script: make fetch
    displayName: make fetch
  - script: docker build -t alpine-fastpack linux-build/alpine
    displayName: 'docker build'
  - script: docker run --rm --mount src=`pwd`,target=/fastpack,type=bind alpine-fastpack /bin/bash -c 'cd /fastpack && make install && make test && make setup-test && make test-integration'
    displayName: 'make test'

- job: MacOS
  pool:
    vmImage: 'macOS 10.13'
  variables:
    TRAVIS_OS_NAME: osx
  steps:
  - script: make fetch
    displayName: make fetch
  - script: npm install -g yarn
    displayName: install Yarn
  - script: npm install -g esy@0.2.11
    displayName: install esy
  - script: make install
    displayName: make install
  - script: make test
    displayName: make test
  - script: make setup-test
    displayName: make setup-test
  - script: make test-integration
    displayName: make test-integration
  - script: make build
    displayName: make build (release)
  - script: |
      mkdir -p dist/vendor-darwin && \
      cp -R _build/default/bin/fpack.exe dist/vendor-darwin && \
      cp -R node-service dist && \
      rm -rf flow flow_parser node_modules
    displayName: prepare release
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: 'vendor-darwin'
      pathToPublish: 'dist'

